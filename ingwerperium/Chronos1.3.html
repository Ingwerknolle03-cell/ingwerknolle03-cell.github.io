<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Chronos V 3.0 (Neues System/Layout/Features)</title>
<style>
html,body{margin:0;padding:0;height:100%;width:100%;font-family:monospace;background:#1c1c1c;color:#ccc;}
body{display:flex;flex-direction:row;}
#main{flex:3;display:flex;flex-direction:column;padding:16px;border-right:1px solid #444;height:100vh;box-sizing:border-box;overflow:hidden;}
#side{flex:1;display:flex;flex-direction:column;padding:16px;background:#111;height:100vh;box-sizing:border-box;overflow-y:auto;}
h1,h2{margin:0 0 10px;color:#e0e0e0;}
#log{flex:1;background:#111;border:1px solid #333;padding:8px;overflow:auto;font-size:13px;margin-bottom:10px;}
#table{flex:1;background:#111;border:1px solid #333;padding:8px;overflow:auto;font-size:13px;}
button{background:#2a2f36;color:#ddd;border:1px solid #555;padding:6px;margin:4px 0;cursor:pointer;width:100%;}
button:hover{background:#3a4048;}
input[type=file]{display:none;}
</style>
</head>
<body>

<div id="main">
  <h1>Chronos</h1>
  <div id="log"></div>
  <div id="table"></div>
  <div>
    <button onclick="running=!running">Start / Pause</button>
    <button onclick="saveGame()">Speichern</button>
    <button onclick="document.getElementById('fileInput').click()">Laden</button>
    <input type="file" id="fileInput" accept=".json" onchange="loadGame(event)">
  </div>
</div>

<div id="side">
  <h2>Pflanzen</h2>
  <div id="plants"></div>
  <h2>Tiere</h2>
  <div id="animals"></div>
  <h2>Pilze</h2>
  <div id="fungi"></div>
  <h2>Substrate</h2>
  <div id="substrates"></div>
</div>

<script>
/* ================= BASIS ================= */
const logBox=document.getElementById("log");
const tableBox=document.getElementById("table");
let running=true;
let stepCount=0;
let seasonIndex=0;
const seasons=["Frühling","Sommer","Herbst","Winter"];

/* ================= SUBSTRATE ================= */
let substrates={Erde:0,Wasser:0,Sand:0,Sumpf:0}; // # Faktoren dynamisch, können wachsen oder schrumpfen

/* ================= ARTEN ================= */
const species={
  // Pflanzen
  "Gräser":{typ:"pflanze",substrat:["Erde"],wachstum:0.25,max:1200},
  "Buchen":{typ:"pflanze",substrat:["Erde"],wachstum:0.08,max:600},
  "Farne":{typ:"pflanze",substrat:["Erde","Sumpf"],wachstum:0.18,max:800},
  "Algen":{typ:"pflanze",substrat:["Wasser"],wachstum:0.22,max:500},
  "Wasserpflanzen":{typ:"pflanze",substrat:["Wasser","Sumpf"],wachstum:0.2,max:400},

  // Tiere Land
  "Mammut":{typ:"tier",frisst:["Gräser"],feinde:["Säbelzahntiger"],substrat:["Erde"],wachstum:0.06,max:200},
  "Pferd":{typ:"tier",frisst:["Gräser"],feinde:["Säbelzahntiger","Wolf"],substrat:["Erde"],wachstum:0.08,max:150},
  "Säbelzahntiger":{typ:"tier",frisst:["Mammut","Pferd"],feinde:[],substrat:["Erde"],wachstum:0.05,max:80},
  "Wolf":{typ:"tier",frisst:["Pferd"],feinde:[],substrat:["Erde"],wachstum:0.07,max:60},
  "Kellerasseln":{typ:"tier",frisst:["Farne"],feinde:["Pferd","Mammut"],substrat:["Erde","Sumpf"],wachstum:0.15,max:300},

  // Tiere Sumpf
  "Sumpffrosch":{typ:"tier",frisst:["Algen","Wasserpflanzen"],feinde:["Räuberfisch"],substrat:["Sumpf"],wachstum:0.12,max:150},

  // Aquatische Tiere
  "Urzeitfisch":{typ:"tier",frisst:["Algen","Wasserpflanzen"],feinde:["Räuberfisch"],substrat:["Wasser"],wachstum:0.12,max:120},
  "Räuberfisch":{typ:"tier",frisst:["Urzeitfisch","Sumpffrosch"],feinde:[],substrat:["Wasser"],wachstum:0.08,max:50},

  // Pilze
  "Pilze":{typ:"pilz",zersetzt:true,substrat:["Erde","Sumpf"],wachstum:0.2,max:900}
};

/* ================= WELT ================= */
let world={};
Object.keys(species).forEach(s=>world[s]=0);
let biomass=0; // organische Masse für Pilze

/* ================= LOG ================= */
function log(text){
  logBox.innerText += text + "\n";
  logBox.scrollTop = logBox.scrollHeight; // # Automatisches Scrollen oben
}

/* ================= DARSTELLUNG ================= */
function draw(){
  tableBox.innerHTML=`Jahreszeit: ${seasons[seasonIndex]}<br><br>`;
  tableBox.innerHTML+="<b>Substrate:</b><br>";
  Object.entries(substrates).forEach(([k,v])=>{
    tableBox.innerHTML+=`${k}: Faktor ${v.toFixed(2)}<br>`;
  });
  tableBox.innerHTML+="<br><b>Arten:</b><br>";
  Object.entries(world).forEach(([k,v])=>{
    if(v>0) tableBox.innerHTML+=`${k}: ${v}<br>`;
  });
}

/* ================= SIMULATION ================= */
function step(){
  stepCount++;
  // Eiszeit-Event zufällig im Winter
  let iceFactor=1;
  if(seasons[seasonIndex]==="Winter" && Math.random()<0.05){
    iceFactor=0.5;
    log("❄ Eiszeit-Event: Pflanzen & Landtiere wachsen langsamer!");
  }

  if(stepCount % 50 === 0){
    seasonIndex=(seasonIndex+1)%4;
    log(`— Neue Jahreszeit: ${seasons[seasonIndex]} —`);
  }

  // Wachstum & Überleben
  Object.entries(species).forEach(([name,sp])=>{
    if(world[name]<=0) return;

    let seasonFactor=1;
    if(seasons[seasonIndex]==="Winter") seasonFactor=0.4;
    if(seasons[seasonIndex]==="Sommer") seasonFactor=1.2;

    let foodFactor=1;
    if(sp.frisst){
      const food=sp.frisst.reduce((s,f)=>s+(world[f]||0),0);
      if(food<=0) foodFactor=0.2;
    }

    // Substratfaktor dynamisch
    const substrateFactor = sp.substrat.reduce((s,f)=>s+substrates[f],0)/sp.substrat.length;

    const delta=Math.floor(world[name]*sp.wachstum*seasonFactor*foodFactor*substrateFactor*iceFactor*(1-world[name]/sp.max));

    if(delta>0){
      world[name]+=delta;
      log(`${name} wachsen (+${delta})`);
    } else if(sp.frisst && foodFactor<0.5){
      const sterbe=Math.max(1,Math.floor(world[name]*0.05));
      world[name]-=sterbe;
      log(`${name} stirbt wegen Nahrungsknappheit (-${sterbe})`);
      if(world[name]<0) world[name]=0;
    }
  });

  // Fressen
  Object.entries(species).forEach(([pred,sp])=>{
    if(!sp.frisst||world[pred]<=0) return;
    sp.frisst.forEach(prey=>{
      if(world[prey]>0){
        const eat=Math.min(world[prey],Math.floor(world[pred]*0.15));
        if(eat>0){
          world[prey]-=eat;
          biomass+=eat; 
          log(`${pred} fressen ${prey} (-${eat})`);
        }
      }
    });
  });

  // Pilze – Zersetzer
  if(world["Pilze"]>0 && biomass>0){
    const grow=Math.floor(biomass*0.1);
    const actualGrow=Math.min(grow, species["Pilze"].max-world["Pilze"]);
    if(actualGrow>0){
      world["Pilze"]+=actualGrow;
      biomass-=actualGrow;
      log(`Pilze vermehren sich durch Zersetzung (+${actualGrow})`);
    }
  }

  draw();
}

/* ================= ZEIT ================= */
setInterval(()=>{ if(running) step(); },2000);

/* ================= BUTTONS ================= */
function addButtons(){
  Object.entries(species).forEach(([n,s])=>{
    const b=document.createElement("button");
    b.innerText=n;
    b.onclick=()=>{
      world[n]+=s.typ==="pflanze"?80: s.typ==="tier"?20:40;
      log(`${n} entstehen`);
      draw();
    };
    document.getElementById(
      s.typ==="pflanze"?"plants":s.typ==="tier"?"animals":"fungi"
    ).appendChild(b);
  });

  // Substrate dynamisch erhöhen
  Object.keys(substrates).forEach(sub=>{
    const b=document.createElement("button");
    b.innerText=sub+" (+0.5)";
    b.onclick=()=>{
      substrates[sub]+=0.5;
      log(`${sub} erhöht sich. Faktor jetzt: ${substrates[sub].toFixed(2)}`);
      draw();
    };
    document.getElementById("substrates").appendChild(b);
  });
}

addButtons();
draw();

/* ================= SPIEL SPEICHERN & LADEN ================= */
function saveGame(){
  const data=JSON.stringify({world,biomass,stepCount,seasonIndex,substrates});
  const blob=new Blob([data],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="chronos_save.json";
  a.click();
  URL.revokeObjectURL(url);
  log("Spiel gespeichert.");
}

function loadGame(event){
  const file=event.target.files[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const data=JSON.parse(e.target.result);
      world=data.world||world;
      biomass=data.biomass||0;
      stepCount=data.stepCount||0;
      seasonIndex=data.seasonIndex||0;
      substrates=data.substrates||substrates;
      log("Spiel geladen.");
      draw();
    }catch{
      alert("Fehler beim Laden.");
    }
  };
  reader.readAsText(file);
  event.target.value="";
}
</script>
</body>
</html>
