<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Blumen-Simulator</title>
<style>
body { margin:0; background:#a0dca0; display:flex; height:100vh; font-family:sans-serif; }
#gui { width:250px; background:rgba(0,0,0,0.7); padding:10px; display:flex; flex-direction:column; gap:15px; }
.gui-section { display:flex; flex-direction:column; gap:5px; }
.gui-section strong { margin-bottom:5px; color:white; }
.gui-buttons { display:flex; flex-wrap:wrap; gap:5px; }
button { cursor:pointer; padding:6px 10px; border-radius:5px; border:none; }
.status-bar { display:flex; flex-direction:column; gap:6px; margin-top:5px;}
.status-fill { height:16px; width:0%; border-radius:4px; }
#container { flex:1; display:flex; justify-content:center; align-items:center; }
canvas { background:#88cc88; border:1px solid #444; }
#statusSeeds, #statusFertilizer { color:#a0e0ff; }
#statusMode { color:red; }
.status-bar div:first-child,
.status-bar div:nth-child(3),
.status-bar div:nth-child(5) { color:#40E0D0; }
</style>
</head>
<body>

<div id="gui">
  <div class="gui-section">
    <strong>Aktionen</strong>
    <div class="gui-buttons">
      <button id="btnRain">üåß Regen</button>
      <button id="btnSun">‚òÄ Sonne</button>
      <button id="btnGrass">‚úÇ Gras</button>
    </div>
  </div>

  <div class="gui-section">
    <strong>Werkzeuge</strong>
    <div class="gui-buttons">
      <button id="btnSeed">üå± Samen</button>
      <button id="btnShovel">‚õè Schaufel</button>
      <button id="btnFertilizer">üí© D√ºnger</button>
    </div>
  </div>

  <div class="gui-section">
    <strong>Status</strong>
    <span id="statusSeeds">Samen: 0</span>
    <span id="statusFertilizer">D√ºnger: 0</span>
    <span id="statusMode">Modus: Samen</span>

    <div class="status-bar">
      <div>Feuchtigkeit</div>
      <div style="background:#444"><div id="barMoisture" class="status-fill" style="background:#0f0"></div></div>
      <div>Licht</div>
      <div style="background:#444"><div id="barLight" class="status-fill" style="background:#ff0"></div></div>
      <div>Unkraut</div>
      <div style="background:#444"><div id="barWeed" class="status-fill" style="background:#f00"></div></div>
    </div>
  </div>
</div>

<div id="container">
  <canvas id="canvas" width="800" height="500"></canvas>
</div>

<div id="saveLoad" style="position:fixed; bottom:10px; left:10px; background:rgba(0,0,0,0.7); color:white; padding:8px; border-radius:5px; font-size:14px;">
  <button id="btnExport">üì§ Export</button>
  <button id="btnImport">üì• Import</button>
  <input type="file" id="fileInput" style="display:none" accept=".json">
</div>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const yBase = canvas.height * 0.4;

let flowers = [], grass = [], particles = [];
let seeds = 0, fertilizer = 0;
let rain = false, sun = false, mode = "seed";
let lastRandomKill = Date.now();

// Globale Environment-Werte f√ºr UI
let envMoisture = 500, envLight = 500, envWeed = 500;

// Wiese erzeugen
for (let i = 0; i < 1200; i++) {
  const d = Math.random();
  grass.push({
    x: Math.random() * canvas.width,
    y: yBase + d * (canvas.height - yBase),
    height: 4 + d * 30,
    maxHeight: 10 + d * 60,
    green: 120 + d * 90
  });
}

// Blume erzeugen
function addFlower(x, y) {
  if (y < yBase) return;
  const colors = ["pink", "red", "purple", "orange", "blue"];
  flowers.push({
    x, y,
    stage: 0,
    moisture: 500,
    light: 500,
    weed: 500,
    alive: true,
    wilted: false,
    wiltStart: null,
    bloomType: Math.floor(Math.random() * 3),
    leaves: 1 + Math.floor(Math.random() * 3),
    color: colors[Math.floor(Math.random() * colors.length)],
    fertilized: false // NEU: Flag f√ºr D√ºnger
  });
}
addFlower(canvas.width / 2, yBase + 60);

// Update
function update(dt) {
  const now = Date.now();

  envMoisture -= 0.014 * dt;
  envLight -= 0.012 * dt;
  envWeed -= 0.03 * dt;

  if (rain) envMoisture = Math.min(1000, envMoisture + 0.25 * dt);
  if (sun) envLight = Math.min(1000, envLight + 0.2 * dt);

  flowers.forEach(f => {
    if (!f.alive) return;

    f.moisture -= 0.014 * dt;
    f.light -= 0.012 * dt;
    f.weed -= 0.03 * dt;

    if (rain) f.moisture = Math.min(1000, f.moisture + 0.25 * dt);
    if (sun) f.light = Math.min(1000, f.light + 0.2 * dt);

    let growthBoost = (mode === "fertilizer" && fertilizer > 0) ? 2 : 1;
    if (f.moisture > 30 && f.light > 30 && f.weed > 30 && f.stage < 10)
      f.stage += 0.001 * growthBoost * dt;

    if (f.moisture < 10 || f.moisture > 900 || f.light < 10 || f.light > 900 || f.weed < 10 || f.weed > 900) {
      if (!f.wiltStart) f.wiltStart = now;
      f.wilted = true;
      if (now - f.wiltStart > 5000) {
        f.alive = false;
        seeds += f.stage >= 9 ? 2 : 1;
      }
    } else {
      f.wilted = false;
      f.wiltStart = null;
    }
  });

  // Random Kill durch Alter nur f√ºr ungefertigte Blumen
  if (now - lastRandomKill > 20000) {
    const adults = flowers.filter(f => f.alive && f.stage >= 10 && !f.fertilized);
    if (adults.length) {
      const toKill = adults[Math.floor(Math.random() * adults.length)];
      toKill.alive = false;
      seeds += 2;
    }
    lastRandomKill = now;
  }

  grass.forEach(g => { if (g.height < g.maxHeight) g.height += 0.01; });

  if (rain) {
    for (let i = 0; i < 3; i++)
      particles.push({ x: Math.random() * canvas.width, y: 0, vy: 2 + Math.random() * 2 });
  }
  for (let i = particles.length - 1; i >= 0; i--) {
    particles[i].y += particles[i].vy * dt;
    if (particles[i].y > canvas.height) particles.splice(i, 1);
  }

  document.getElementById("statusSeeds").textContent = `Samen: ${seeds}`;
  document.getElementById("statusFertilizer").textContent = `D√ºnger: ${fertilizer}`;
  document.getElementById("statusMode").textContent = `Modus: ${mode}`;

  document.getElementById("barMoisture").style.width = Math.min(100, envMoisture / 10) + "%";
  document.getElementById("barLight").style.width = Math.min(100, envLight / 10) + "%";
  document.getElementById("barWeed").style.width = Math.min(100, envWeed / 10) + "%";
}

// Zeichnen (unver√§ndert)
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = sun ? "#FFDFA0" : "#87CEEB";
  ctx.fillRect(0, 0, canvas.width, yBase);
  ctx.fillStyle = "#88cc88";
  ctx.fillRect(0, yBase, canvas.width, canvas.height - yBase);

  grass.forEach(g => {
    ctx.fillStyle = `rgb(30,${g.green},30)`;
    ctx.fillRect(g.x, g.y - g.height, 2, g.height);
  });

  flowers.forEach(f => {
    const h = 20 + f.stage * 6;
    ctx.save();
    ctx.translate(f.x, f.y);
    if (f.wilted) ctx.rotate(-0.4);

    ctx.fillStyle = f.alive ? "#228B22" : "#654321";
    ctx.fillRect(-2, -h, 4, h);

    ctx.fillStyle = "#2e8b57";
    for (let i = 0; i < f.leaves; i++) {
      const d = i % 2 ? -1 : 1;
      ctx.beginPath();
      ctx.ellipse(d * (6 + f.stage), -h / 2 - i * 5, 4 + f.stage / 3, 8 + f.stage / 2, d * 0.5, 0, Math.PI * 2);
      ctx.fill();
    }

    if (f.alive) {
      ctx.fillStyle = f.wilted ? "#888" : f.color;
      for (let i = 0; i < 6; i++) {
        const a = i * Math.PI / 3;
        ctx.beginPath();
        if (f.bloomType === 0)
          ctx.arc(Math.cos(a) * (6 + f.stage), -h + Math.sin(a) * (6 + f.stage), 4 + f.stage / 2, 0, Math.PI * 2);
        else if (f.bloomType === 1)
          ctx.ellipse(Math.cos(a) * (8 + f.stage), -h + Math.sin(a) * (8 + f.stage), 3 + f.stage / 2, 10 + f.stage, a, 0, Math.PI * 2);
        else
          ctx.ellipse(Math.cos(a) * (6 + f.stage), -h + Math.sin(a) * (6 + f.stage), 6 + f.stage, 4 + f.stage / 2, a, 0, Math.PI * 2);
        ctx.fill();
      }
      ctx.fillStyle = "yellow";
      ctx.beginPath();
      ctx.arc(0, -h, 4 + f.stage / 2, 0, Math.PI * 2);
      ctx.fill();
    }
    ctx.restore();
  });

  ctx.fillStyle = "#00f";
  particles.forEach(p => ctx.fillRect(p.x, p.y, 2, 2));
}

// Loop
function loop() { update(1); draw(); requestAnimationFrame(loop); }
loop();

// UI Events
function momentary(type) { 
  if (type === "rain") { rain = true; setTimeout(() => rain = false, 5000); } 
  if (type === "sun") { sun = true; setTimeout(() => sun = false, 5000); } 
}
btnRain.onclick = () => momentary("rain");
btnSun.onclick = () => momentary("sun");

// Grass
btnGrass.onclick = () => {
  flowers.forEach(f => { if (f.alive) f.weed = Math.min(1000, f.weed + 80); });
  grass.forEach(g => g.height = Math.max(2, g.height - 10));
  envWeed = Math.min(1000, envWeed + 80);
};

btnSeed.onclick = () => mode = "seed";
btnShovel.onclick = () => mode = "shovel";
btnFertilizer.onclick = () => mode = "fertilizer";

// Maus
canvas.onclick = e => {
  const r = canvas.getBoundingClientRect();
  const x = e.clientX - r.left;
  const y = e.clientY - r.top;
  if (y < yBase) return;

  if (mode === "seed" && seeds > 0) { addFlower(x, y); seeds--; }

  if (mode === "shovel") {
    for (let i = flowers.length - 1; i >= 0; i--) {
      const f = flowers[i];
      const h = 20 + f.stage * 6;
      if (!f.alive && Math.hypot(x - f.x, y - (f.y - h)) < 40) {
        flowers.splice(i, 1);
        fertilizer++;
        break;
      }
    }
  }

  if (mode === "fertilizer" && fertilizer > 0) {
    flowers.forEach(f => {
      const h = 20 + f.stage * 6;
      if (f.alive && Math.hypot(x - f.x, y - (f.y - h)) < 30) {
        f.stage += 2;
        f.fertilized = true; // NEU: markiere als ged√ºngt
        fertilizer--;
      }
    });
  }
};

// Export / Import
document.getElementById("btnExport").onclick = () => {
  const saveData = { seeds, fertilizer, flowers, grass, envMoisture, envLight, envWeed };
  const blob = new Blob([JSON.stringify(saveData, null, 2)], {type: "application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "blumen_simulator_save.json";
  a.click();
  URL.revokeObjectURL(url);
};

document.getElementById("btnImport").onclick = () => {
  document.getElementById("fileInput").click();
};

document.getElementById("fileInput").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = evt => {
    try {
      const data = JSON.parse(evt.target.result);
      seeds = data.seeds ?? seeds;
      fertilizer = data.fertilizer ?? fertilizer;
      flowers = data.flowers ?? flowers;
      grass = data.grass ?? grass;
      envMoisture = data.envMoisture ?? envMoisture;
      envLight = data.envLight ?? envLight;
      envWeed = data.envWeed ?? envWeed;
      alert("Spielstand geladen!");
    } catch (err) {
      alert("Fehler beim Laden des Spielstands!");
      console.error(err);
    }
  };
  reader.readAsText(file);
});
</script>
</body>
</html>


